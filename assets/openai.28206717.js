import{f as G,C as Q,R as X,H as F,z as ee,g as k,h as J,i as W,j as $,k as te,p as ne,l as re,S as ae,A as oe}from"./index.89d23345.js";class ie extends G{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}async generate(e,t,n){var i;const r=[],a=[];let s;Array.isArray(t)?s={stop:t}:(t==null?void 0:t.timeout)&&!t.signal?s={...t,signal:AbortSignal.timeout(t.timeout)}:s=t!=null?t:{};const h=await Q.configure(n,this.callbacks,s.tags,this.tags,{verbose:this.verbose}),g={options:s,invocation_params:this==null?void 0:this.invocationParams()},u=await(h==null?void 0:h.handleChatModelStart(this.toJSON(),e,void 0,void 0,g));try{const p=await Promise.all(e.map(m=>this._generate(m,s,u)));for(const m of p)m.llmOutput&&a.push(m.llmOutput),r.push(m.generations)}catch(p){throw await(u==null?void 0:u.handleLLMError(p)),p}const o={generations:r,llmOutput:a.length?(i=this._combineLLMOutput)==null?void 0:i.call(this,...a):void 0};return await(u==null?void 0:u.handleLLMEnd(o)),Object.defineProperty(o,X,{value:u?{runId:u==null?void 0:u.runId}:void 0,configurable:!0}),o}invocationParams(){return{}}_modelType(){return"base_chat_model"}async generatePrompt(e,t,n){const r=e.map(a=>a.toChatMessages());return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new F(e);return(await this.call([r],t,n)).text}}function se(c){return{name:c.name,description:c.description,parameters:ee.zodToJsonSchema(c.schema)}}function C(c){switch(c){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";default:throw new Error(`Unknown message type: ${c}`)}}function ue(c){var e;switch(c.role){case"user":return new F(c.content||"");case"assistant":return new oe(c.content||"",{function_call:c.function_call});case"system":return new ae(c.content||"");default:return new re(c.content||"",(e=c.role)!=null?e:"unknown")}}class ce extends ie{get callKeys(){return["stop","signal","timeout","options","functions","tools"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var g,u,o,i,p,m,A,_,O,w,f,d,T;super(e!=null?e:{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const n=(g=e==null?void 0:e.openAIApiKey)!=null?g:k("OPENAI_API_KEY"),r=(u=e==null?void 0:e.azureOpenAIApiKey)!=null?u:k("AZURE_OPENAI_API_KEY");if(!r&&!n)throw new Error("(Azure) OpenAI API key not found");const a=(o=e==null?void 0:e.azureOpenAIApiInstanceName)!=null?o:k("AZURE_OPENAI_API_INSTANCE_NAME"),s=(i=e==null?void 0:e.azureOpenAIApiDeploymentName)!=null?i:k("AZURE_OPENAI_API_DEPLOYMENT_NAME"),h=(p=e==null?void 0:e.azureOpenAIApiVersion)!=null?p:k("AZURE_OPENAI_API_VERSION");if(this.modelName=(m=e==null?void 0:e.modelName)!=null?m:this.modelName,this.modelKwargs=(A=e==null?void 0:e.modelKwargs)!=null?A:{},this.timeout=e==null?void 0:e.timeout,this.temperature=(_=e==null?void 0:e.temperature)!=null?_:this.temperature,this.topP=(O=e==null?void 0:e.topP)!=null?O:this.topP,this.frequencyPenalty=(w=e==null?void 0:e.frequencyPenalty)!=null?w:this.frequencyPenalty,this.presencePenalty=(f=e==null?void 0:e.presencePenalty)!=null?f:this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.n=(d=e==null?void 0:e.n)!=null?d:this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.streaming=(T=e==null?void 0:e.streaming)!=null?T:!1,this.azureOpenAIApiVersion=h,this.azureOpenAIApiKey=r,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=s,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:n,...t,...e==null?void 0:e.configuration}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){var p,m,A,_,O,w,f,d,T;const r={};if(this.stop&&(t==null?void 0:t.stop))throw new Error("Stop found in input and default params");const a=this.invocationParams();a.stop=(p=t==null?void 0:t.stop)!=null?p:a.stop,a.functions=(m=t==null?void 0:t.functions)!=null?m:t!=null&&t.tools?t==null?void 0:t.tools.map(se):void 0,a.function_call=t==null?void 0:t.function_call;const s=e.map(b=>({role:C(b._getType()),content:b.text,name:b.name})),h=a.stream?await new Promise((b,E)=>{let P,j=!1,v=!1;this.completionWithRetry({...a,messages:s},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options,adapter:J,responseType:"stream",onmessage:N=>{var z,K,x,L,R,M,D,U,S,q,V,Y,B,Z;if(((K=(z=N.data)==null?void 0:z.trim)==null?void 0:K.call(z))==="[DONE]"){if(v)return;v=!0,b(P)}else{const I=JSON.parse(N.data);P||(P={id:I.id,object:I.object,created:I.created,model:I.model,choices:[]});for(const l of I.choices)if(l!=null){let y=P.choices.find(H=>H.index===l.index);y||(y={index:l.index,finish_reason:(x=l.finish_reason)!=null?x:void 0},P.choices[l.index]=y),y.message||(y.message={role:(L=l.delta)==null?void 0:L.role,content:""}),l.delta.function_call&&!y.message.function_call&&(y.message.function_call={name:"",arguments:""}),y.message.content+=(M=(R=l.delta)==null?void 0:R.content)!=null?M:"",y.message.function_call&&(y.message.function_call.name+=(S=(U=(D=l.delta)==null?void 0:D.function_call)==null?void 0:U.name)!=null?S:"",y.message.function_call.arguments+=(Y=(V=(q=l.delta)==null?void 0:q.function_call)==null?void 0:V.arguments)!=null?Y:""),n==null||n.handleLLMNewToken((Z=(B=l.delta)==null?void 0:B.content)!=null?Z:"")}!v&&I.choices.every(l=>l.finish_reason!=null)&&(v=!0,b(P))}}}).catch(N=>{j||(j=!0,E(N))})}):await this.completionWithRetry({...a,messages:s},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:g,prompt_tokens:u,total_tokens:o}=(A=h.usage)!=null?A:{};g&&(r.completionTokens=((_=r.completionTokens)!=null?_:0)+g),u&&(r.promptTokens=((O=r.promptTokens)!=null?O:0)+u),o&&(r.totalTokens=((w=r.totalTokens)!=null?w:0)+o);const i=[];for(const b of h.choices){const E=(d=(f=b.message)==null?void 0:f.content)!=null?d:"";i.push({text:E,message:ue((T=b.message)!=null?T:{role:"assistant"})})}return{generations:i,llmOutput:{tokenUsage:r}}}async getNumTokensFromMessages(e){let t=0,n=0,r=0;W(this.modelName)==="gpt-3.5-turbo"?(n=4,r=-1):W(this.modelName).startsWith("gpt-4")&&(n=3,r=1);const a=await Promise.all(e.map(async s=>{const h=await this.getNumTokens(s.text),g=await this.getNumTokens(C(s._getType())),u=s.name!==void 0?r+await this.getNumTokens(s.name):0,o=h+n+g+u;return t+=o,o}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){if(!this.client){const r=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new $.Configuration({...this.clientConfig,basePath:r,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new $.OpenAIApi(a)}const n={adapter:te()?void 0:J,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(n.headers={"api-key":this.azureOpenAIApiKey,...n.headers},n.params={"api-version":this.azureOpenAIApiVersion,...n.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,n).then(r=>r.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,n)=>{var r,a,s;return n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=(r=n.tokenUsage.completionTokens)!=null?r:0,t.tokenUsage.promptTokens+=(a=n.tokenUsage.promptTokens)!=null?a:0,t.tokenUsage.totalTokens+=(s=n.tokenUsage.totalTokens)!=null?s:0),t},{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}class pe extends ce{constructor(e){var t,n,r;super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.promptLayerApiKey=(t=e==null?void 0:e.promptLayerApiKey)!=null?t:typeof process<"u"?{}.PROMPTLAYER_API_KEY:void 0,this.plTags=(n=e==null?void 0:e.plTags)!=null?n:[],this.returnPromptLayerId=(r=e==null?void 0:e.returnPromptLayerId)!=null?r:!1}async _generate(e,t,n){const r=Date.now();let a;Array.isArray(t)?a={stop:t}:(t==null?void 0:t.timeout)&&!t.signal?a={...t,signal:AbortSignal.timeout(t.timeout)}:a=t!=null?t:{};const s=await super._generate(e,a,n),h=Date.now(),g=o=>{let i;if(o._getType()==="human")i={role:"user",content:o.text};else if(o._getType()==="ai")i={role:"assistant",content:o.text};else if(o._getType()==="system")i={role:"system",content:o.text};else if(o._getType()==="generic")i={role:o.role,content:o.text};else throw new Error(`Got unknown type ${o}`);return i},u=(o,i)=>{const p={...this.invocationParams(),model:this.modelName};if(i!=null&&i.stop&&Object.keys(p).includes("stop"))throw new Error("`stop` found in both the input and default params.");return o.map(A=>g(A))};for(let o=0;o<s.generations.length;o+=1){const i=s.generations[o],p=u(e,a);let m;const A=[{content:i.text,role:C(i.message._getType())}],_=await ne(this.caller,"langchain.PromptLayerChatOpenAI",p,this._identifyingParams(),this.plTags,A,r,h,this.promptLayerApiKey);this.returnPromptLayerId===!0&&(_.success===!0&&(m=_.request_id),(!i.generationInfo||typeof i.generationInfo!="object")&&(i.generationInfo={}),i.generationInfo.promptLayerRequestId=m)}return s}}export{ce as ChatOpenAI,pe as PromptLayerChatOpenAI};
