import{b,H as f,P as l,S as d,d as g,e as w,L as y,a as m}from"./index.89d23345.js";import{StuffDocumentsChain as P}from"./combine_docs_chain.4ad5934f.js";class v{async getPromptAsync(e,t){var s;return this.getPrompt(e).partial((s=t==null?void 0:t.partialVariables)!=null?s:{})}}class V extends v{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(const[t,r]of this.conditionals)if(t(e))return r;return this.defaultPrompt}}function _(i){return i._modelType()==="base_chat_model"}class M extends w{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}}class S extends g{constructor(e){Array.isArray(e)&&(e={messages:e}),super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return JSON.stringify(this.messages)}toChatMessages(){return this.messages}}class p extends M{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class O extends b{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new S(t)}}class C extends p{async format(e){return new f(await this.prompt.format(e))}static fromTemplate(e){return new this(l.fromTemplate(e))}}class D extends p{async format(e){return new d(await this.prompt.format(e))}static fromTemplate(e){return new this(l.fromTemplate(e))}}class o extends O{get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){const t=new Set;for(const a of this.promptMessages)for(const u of a.inputVariables)t.add(u);const r=new Set(this.partialVariables?this.inputVariables.concat(Object.keys(this.partialVariables)):this.inputVariables),s=new Set([...r].filter(a=>!t.has(a)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are not used in any of the prompt messages.`);const n=new Set([...t].filter(a=>!r.has(a)));if(n.size>0)throw new Error(`Input variables \`${[...n]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let r=[];for(const s of this.promptMessages){const n=s.inputVariables.reduce((u,c)=>{if(!(c in t))throw new Error(`Missing value for input variable \`${c}\``);return u[c]=t[c],u},{}),a=await s.formatMessages(n);r=r.concat(a)}return r}async partial(e){var r;const t={...this};return t.inputVariables=this.inputVariables.filter(s=>!(s in e)),t.partialVariables={...(r=this.partialVariables)!=null?r:{},...e},new o(t)}static fromPromptMessages(e){const t=e.reduce((n,a)=>n.concat(a instanceof o?a.promptMessages:[a]),[]),r=e.reduce((n,a)=>a instanceof o?Object.assign(n,a.partialVariables):n,Object.create(null)),s=new Set;for(const n of t)for(const a of n.inputVariables)a in r||s.add(a);return new o({inputVariables:[...s],promptMessages:t,partialVariables:r})}}const T=new l({template:`Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.

{context}

Question: {question}
Helpful Answer:`,inputVariables:["context","question"]}),j=`Use the following pieces of context to answer the users question. 
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}`,k=[D.fromTemplate(j),C.fromTemplate("{question}")],x=o.fromPromptMessages(k),A=new V(T,[[_,x]]);function z(i,e={}){const{prompt:t=A.getPrompt(i),verbose:r}=e,s=new y({prompt:t,llm:i,verbose:r});return new P({llmChain:s,verbose:r})}class h extends m{get inputKeys(){return[this.inputKey]}get outputKeys(){return this.combineDocumentsChain.outputKeys.concat(this.returnSourceDocuments?["sourceDocuments"]:[])}constructor(e){var t,r,s;super(e),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"query"}),Object.defineProperty(this,"vectorstore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"combineDocumentsChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSourceDocuments",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.vectorstore=e.vectorstore,this.combineDocumentsChain=e.combineDocumentsChain,this.inputKey=(t=e.inputKey)!=null?t:this.inputKey,this.k=(r=e.k)!=null?r:this.k,this.returnSourceDocuments=(s=e.returnSourceDocuments)!=null?s:this.returnSourceDocuments}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Question key ${this.inputKey} not found.`);const r=e[this.inputKey],s=await this.vectorstore.similaritySearch(r,this.k,e.filter),n={question:r,input_documents:s},a=await this.combineDocumentsChain.call(n,t==null?void 0:t.getChild("combine_documents"));return this.returnSourceDocuments?{...a,sourceDocuments:s}:a}_chainType(){return"vector_db_qa"}static async deserialize(e,t){if(!("vectorstore"in t))throw new Error("Need to pass in a vectorstore to deserialize VectorDBQAChain");const{vectorstore:r}=t;if(!e.combine_documents_chain)throw new Error("VectorDBQAChain must have combine_documents_chain in serialized data");return new h({combineDocumentsChain:await m.deserialize(e.combine_documents_chain),k:e.k,vectorstore:r})}serialize(){return{_type:this._chainType(),combine_documents_chain:this.combineDocumentsChain.serialize(),k:this.k}}static fromLLM(e,t,r){const s=z(e);return new this({vectorstore:t,combineDocumentsChain:s,...r})}}export{h as VectorDBQAChain};
